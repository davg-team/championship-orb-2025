# Система локального хранилища секретов

## Обзор реализации

Создана полноценная система локального хранилища секретов с шифрованием на основе мастер-пароля.

## Архитектура

### Backend (Rust)

**Файл:** `client/src-tauri/src/vault/secrets.rs`

#### Структуры данных:
- `SecretStore` - хранилище с флагом инициализации и хешем мастер-пароля
- `EncryptedSecret` - зашифрованный секрет с метаданными
- `SecretListItem` - метаданные для отображения списка (без расшифровки)

#### Команды Tauri:
1. **Инициализация:**
   - `is_vault_initialized()` - проверка инициализации
   - `initialize_vault(master_password)` - первичная настройка с паролем
   - `verify_vault_password(master_password)` - проверка пароля
   - `change_master_password(old, new)` - смена пароля с перешифрованием

2. **Работа с секретами:**
   - `list_secrets()` - список метаданных (БЕЗ пароля)
   - `save_secret(secret, password)` - сохранение (С паролем)
   - `get_secret(id, password)` - получение (С паролем)
   - `update_secret(secret, password)` - обновление (С паролем)
   - `delete_secret(id)` - удаление

#### Безопасность:
- Мастер-пароль **НЕ хранится** нигде
- Хранится только **SHA-256 хеш** для проверки
- Пароль преобразуется в ключ шифрования через хеширование
- Используется **ChaCha20-Poly1305** для шифрования
- Все секреты зашифрованы индивидуально

### Frontend (React + TypeScript)

#### Компоненты:

1. **VaultInitializer** (`features/components/VaultInitializer.tsx`)
   - Отображается при первом запуске
   - Создание мастер-пароля (минимум 8 символов)
   - Подтверждение пароля
   - Инициализация хранилища

2. **VaultUnlock** (`features/components/VaultUnlock.tsx`)
   - Отображается при каждом запуске после инициализации
   - Ввод мастер-пароля
   - Разблокировка хранилища

3. **VaultSession Store** (`app/store/vault-session.tsx`)
   - Хранит мастер-пароль **В ПАМЯТИ** на время сессии
   - Очищается при закрытии приложения
   - Используется для операций с секретами

4. **CreateSecretModal** (обновлён)
   - Больше НЕ запрашивает пароль при каждом сохранении
   - Использует пароль из сессии
   - Автоматически шифрует секреты

#### API обёртки:

**Файл:** `shared/tauri/vault.ts`

```typescript
// Инициализация
isVaultInitialized(): Promise<boolean>
initializeVault(masterPassword): Promise<void>
verifyVaultPassword(masterPassword): Promise<boolean>
changeMasterPassword(old, new): Promise<void>

// Работа с секретами
listSecrets(): Promise<SecretListItem[]>
saveSecret(secret, password): Promise<void>
getSecret(id, password): Promise<Secret>
updateSecret(secret, password): Promise<void>
deleteSecret(id): Promise<void>
```

## Поток работы пользователя

### Первый запуск:
1. Пользователь видит `VaultInitializer`
2. Создаёт мастер-пароль (≥8 символов)
3. Подтверждает пароль
4. Хранилище инициализируется
5. Переход к разблокировке

### Последующие запуски:
1. Пользователь видит `VaultUnlock`
2. Вводит мастер-пароль
3. Пароль проверяется и сохраняется в сессии
4. Доступ к хранилищу открыт

### Работа с секретами:
1. **Список секретов** загружается автоматически (без пароля)
2. **Создание секрета:**
   - Открыть модальное окно
   - Заполнить форму
   - Секрет автоматически шифруется паролем из сессии
3. **Просмотр секрета:**
   - Клик на секрет в таблице
   - Автоматическая расшифровка паролем из сессии
4. **Удаление:** без пароля (только метаданные)

## Хранение данных

**Путь к файлу:** `~/.config/my-tauri-app/v2/secrets.json`

**Структура:**
```json
{
  "version": 2,
  "initialized": true,
  "password_hash": "sha256_hash_here",
  "secrets": [
    {
      "id": "uuid",
      "name": "My Database",
      "type": "database",
      "encrypted_data": "base64_encrypted_json",
      "nonce": "base64_nonce",
      "created_at": "2025-01-01T00:00:00Z",
      "expires_at": null
    }
  ]
}
```

## Безопасность

✅ **Защищено:**
- Мастер-пароль не хранится
- Все секреты зашифрованы
- Современное шифрование (ChaCha20-Poly1305)
- Пароль в памяти только на время сессии
- Локальное хранение (не в облаке)

⚠️ **Важно:**
- Восстановление пароля НЕВОЗМОЖНО
- При потере пароля - данные потеряны навсегда
- Пароль должен быть надёжным (≥8 символов)

## Зависимости

**Rust:**
```toml
sha2 = "0.10"
hex = "0.4"
chacha20poly1305 = "0.10"
```

**TypeScript:**
- Gravity UI компоненты
- Zustand для состояния
- Tauri API

## Тестирование

Для тестирования системы:

1. Удалите старое хранилище:
   ```bash
   rm -rf ~/.config/my-tauri-app/v2/
   ```

2. Запустите приложение:
   ```bash
   cd client
   npm run tauri dev
   ```

3. Проверьте:
   - ✅ Первая инициализация (создание пароля)
   - ✅ Разблокировка при запуске
   - ✅ Создание секретов всех типов
   - ✅ Просмотр секретов
   - ✅ Удаление секретов
   - ✅ Персистентность после перезапуска

## Следующие шаги

- [ ] Добавить таймер автоблокировки
- [ ] Добавить кнопку "Заблокировать хранилище"
- [ ] Реализовать экспорт/импорт секретов
- [ ] Добавить историю изменений
- [ ] Реализовать резервное копирование
