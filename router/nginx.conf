server
{
	listen 80;
	# --- Общие CORS для всех локаций ---
	set $cors_origin '*';
	add_header 'Access-Control-Allow-Origin' $cors_origin always;
	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
	add_header 'Access-Control-Allow-Headers' '*' always;
	add_header 'Access-Control-Max-Age' 3600 always;

	# Обработка preflight для всех локаций
	if ($request_method = 'OPTIONS')
	{
		# add_header 'Content-Length' 0;
		# add_header 'Content-Type' 'text/plain charset=UTF-8';
		return 204;
	}

	# Фронтенд
	location /
	{
		root /frontend/dist/dist/;
		index index.html;
		try_files $uri /index.html;
	}

	# /auth
	location /auth/
	{
		proxy_pass http://keycloak:8080/auth/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_hide_header Content-Security-Policy;
		proxy_hide_header X-Frame-Options;
		
		# Увеличение буферов для больших заголовков (JWT токены)
		proxy_buffer_size 16k;
		proxy_buffers 8 16k;
		proxy_busy_buffers_size 32k;
	}

	# /vault
	location /vault/
	{
		proxy_pass http://openbao:8200/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Accept-Encoding "";
		proxy_redirect /ui/ /vault/ui/;
		sub_filter '<head>' '<head><base href="/vault/">';
		sub_filter '"/ui/' '"ui/';
		sub_filter_once off;
	}

	# /v1
	location /v1
	{
		proxy_pass http://openbao:8200;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# /api/notifications
	location /api/notifications
	{
		proxy_pass http://backend-notifications:8081/api/notifications;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# /api/applications
	location /api/applications
	{
		proxy_pass http://backend_applications:8082/api/applications;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
}

server
{
	listen 443 ssl http2;
	server_name orencode.davg-team.ru;

	resolver 127.0.0.11 valid=30s ipv6=off;

	ssl_certificate /etc/letsencrypt/live/orencode.davg-team.ru/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/orencode.davg-team.ru/privkey.pem;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers HIGH:!aNULL:!MD5;

	# --- Общие CORS для всех локаций ---
	set $cors_origin '*';
	add_header 'Access-Control-Allow-Origin' $cors_origin always;
	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
	add_header 'Access-Control-Allow-Headers' '*' always;
	add_header 'Access-Control-Max-Age' 3600 always;

	# Обработка preflight для всех локаций
	if ($request_method = 'OPTIONS')
	{
		# add_header 'Content-Length' 0;
		# add_header 'Content-Type' 'text/plain charset=UTF-8';
		return 204;
	}

	# Фронтенд
	location /
	{
		root /frontend/dist/dist/;
		index index.html;
		try_files $uri /index.html;
	}

	# /auth
	location /auth/
	{
		proxy_pass http://keycloak:8080/auth/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_hide_header Content-Security-Policy;
		proxy_hide_header X-Frame-Options;
		
		# Увеличение буферов для больших заголовков (JWT токены)
		proxy_buffer_size 16k;
		proxy_buffers 8 16k;
		proxy_busy_buffers_size 32k;
	}

	# /vault
	location /vault/
	{
		proxy_pass http://openbao:8200/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Accept-Encoding "";
		proxy_redirect /ui/ /vault/ui/;
		sub_filter '<head>' '<head><base href="/vault/">';
		sub_filter '"/ui/' '"ui/';
		sub_filter_once off;
	}

	# /v1
	location /v1
	{
		proxy_pass http://openbao:8200;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# /api/notifications
	location /api/notifications
	{
		proxy_pass http://backend-notifications:8081/api/notifications;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# /api/applications
	location /api/applications
	{
		proxy_pass http://backend_applications:8082/api/applications;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
}

server
{
	listen 443 ssl http2;
	server_name l.orencode.davg-team.ru;

	resolver 127.0.0.11 valid=30s ipv6=off;

	ssl_certificate /etc/nginx/certs/l/fullchain.pem;
	ssl_certificate_key /etc/nginx/certs/l/privkey.pem;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers HIGH:!aNULL:!MD5;

	set $cors_origin '*';
	add_header 'Access-Control-Allow-Origin' $cors_origin always;
	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
	add_header 'Access-Control-Allow-Headers' '*' always;
	add_header 'Access-Control-Max-Age' 3600 always;

	if ($request_method = 'OPTIONS')
	{
		return 204;
	}

	# Фронт
	location /
	{
		root /frontend/dist/dist/;
		index index.html;
		try_files $uri /index.html;
	}

	# /auth
	location /auth/
	{
		proxy_pass http://keycloak:8080/auth/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_hide_header Content-Security-Policy;
		proxy_hide_header X-Frame-Options;
		
		# Увеличение буферов для больших заголовков (JWT токены)
		proxy_buffer_size 16k;
		proxy_buffers 8 16k;
		proxy_busy_buffers_size 32k;
	}

	# /vault
	location /vault/
	{
		proxy_pass http://openbao:8200/vault/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Prefix "/vault";
	}
}
